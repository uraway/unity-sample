version: 2.1

jobs:
  test:
    parameters:
      test-platform:
        type: enum
        enum: ['playmode', 'editmode']
    docker:
      - image: gableroux/unity3d:2018.4.16f1
    environment:
      UNITY_EXECUTABLE: /opt/Unity/Editor/Unity
    steps:
      - checkout
      - run:
          name: Decode License content
          command: |
            echo "$UNITY_LICENSE_CONTENT" | base64 --decode | tr -d '\r' > yourulffile.ulf
      - run:
          name: |
            Activation
            logFile: ログ
            batchmode: バッチモード。コマンドラインで完結するようにポップアップを表示しないオプション
            nographics: GPUのないマシンで実行
            manualLicenseFile: ライセンスファイル(.ulf)
          command: |
            /opt/Unity/Editor/Unity -logFile \
                                    -batchmode \
                                    -nographics \
                                    -quit \
                                    -manualLicenseFile yourulffile.ulf || exit 0
      - run:
          name: |
            << parameters.test-platform >> Test
            runTests: テスト実行
            testPlatform: テストプラットフォーム
          command: |
            -xvfb-run --auto-servernum --server-args='-screen 0 640x480x24' /opt/Unity/Editor/Unity -projectPath $(pwd) \
                                    -runTests \
                                    -testPlatform << parameters.test-platform >> \
                                    -testResults $(pwd)/<< parameters.test-platform >>-results.xml \
                                    -logFile \
                                    -batchmode
      - store_artifacts:
            path: << parameters.test-platform >>-results.xml

workflows:
  test-build:
    jobs:
      - test:
          name: test-editmode
          test-platform: editmode
      - test:
          name: test-playmode
          test-platform: playmode
